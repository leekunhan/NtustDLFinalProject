# 犬種辨識分類器

* [資料集下載與準備](#資料集下載與準備)
* [專案概覽](#專案概覽)
* [解決方案](#解決方案)
* [使用方式](#使用方式)
* [專案檔案說明](#專案檔案說明)
* [效能分析](#效能分析)
* [熱力圖分析與模型改進建議](#熱力圖分析與模型改進建議)


## 資料集下載與準備

1. 前往 Kaggle 競賽頁面：https://www.kaggle.com/competitions/dog-breed-identification/data
2. 點擊「Download All」按鈕下載資料集（需要 Kaggle 帳號）
3. 將下載的 zip 檔案解壓縮到專案根目錄
4. 確認檔案結構如下：
   - `train/` - 包含訓練圖片
   - `test/` - 包含測試圖片
   - `labels.csv` - 訓練標籤
   - `sample_submission.csv` - 提交範例格式


本專案是一個使用 PyTorch 框架與預訓練 ResNet-50 模型實現的深度學習（CNN）圖像分類器，用於辨識 120 種不同的犬種。

## 專案概覽

本專案的主要目標是從圖像中準確預測犬種。資料集包含 120 種不同的犬種，競賽任務是建立一個能夠從照片中判斷犬隻品種的分類器。

## 解決方案

### 模型架構
本專案採用遷移學習的策略，並對預訓練模型進行調整以適應犬種辨識任務：
- **基礎模型**：使用在 ImageNet 資料集上預訓練的 ResNet-50 模型。ResNet-50 以其深度殘差學習框架聞名，能夠有效訓練非常深的網路並解決梯度消失問題。
- **頂層修改**：移除了原 ResNet-50 的最後一個全連接層（通常用於 ImageNet 的 1000 類別分類），並替換為一個新的分類頭。這個新的分類頭包含：
    - 一個線性層，將 ResNet-50 提取的特徵從 `in_features` 2048 映射到 512 維。
    - 一個 ReLU 激活函數，引入非線性。
    - 一個 Dropout 層（p=0.5），用於正則化，減少過度擬合。
    - 最後一個線性層，將 512 維特徵映射到 `num_classes` 120個犬種。
- **遷移學習與微調**：
    - **特徵提取**：為了保留預訓練模型學習到的通用圖像特徵，ResNet-50 的大部分卷積層的權重被凍結（`param.requires_grad = False`），使其在訓練初期不進行更新。具體來說，除了最後 20 組參數（主要對應較高層的卷積層和新的分類頭）之外的所有參數都被凍結。

   ```python
   for param in list(self.model.parameters())[:-20]:
      param.requires_grad = False
   ```

    - **微調**：新加入的分類頭以及 ResNet-50 模型中未被凍結的較高層級的參數則進行訓練，使其適應犬種分類的特定任務。這種策略允許模型利用預訓練的知識，同時針對新任務進行優化。

### 資料增強
為了提升模型泛化能力，使用了以下資料增強技術：
- 隨機水平翻轉
- 隨機旋轉
- 亮度、對比度和飽和度調整

### 訓練策略
- 交叉熵損失函數
- Adam 優化器，針對不同層級設定不同學習率
- 學習率排程器：ReduceLROnPlateau
- 提早停止：若驗證準確度連續 10 個 epoch 未提升則停止訓練
- 每 5 個 epoch 定期儲存模型

## 使用方式

1. 確認 `train`、`test` 資料夾和 `labels.csv` 檔案位於正確路徑
2. 安裝所需套件：
```
pip install torch torchvision numpy pandas matplotlib scikit-learn tqdm pillow
```
3. 執行訓練與預測：
```
python dog_breed_classifier.py
```
4. 訓練完成後，將會產生以下檔案：
   - `best_model.pth`：最佳模型權重
   - `model/model_epoch_*.pth`：每 5 個 epoch 儲存的模型
   - `src/images/`：視覺化結果，包含：
     - 損失與準確度曲線
     - 表現最佳與最差犬種的範例
     - 效能摘要
   - `submission.csv`：預測結果（用於提交）

## 專案檔案說明

| 檔案名稱 | 說明 |
|---------|------|
| `dog_breed_classifier.py` | 主要程式碼，包含資料處理、模型定義、訓練與預測流程 |
| `README.md` | 專案文件，提供概覽、使用方式與結果說明 |
| `Changelog.md` | 變更日誌，記錄模型版本與改善歷史 |
| `requirements.txt` | 相依性列表，指定所需的 Python 套件版本 |
| `best_model.pth` | 已訓練的模型權重檔案，儲存驗證準確度最高的模型參數 |
| `src/images/accuracy_curve.png` | 訓練準確度曲線，顯示準確度隨 epoch 變化的情況 |
| `src/images/loss_curve.png` | 訓練損失曲線，顯示損失隨 epoch 變化的情況 |
| `src/images/best_*` | 準確度最高的前 10 種犬種的視覺化結果 |
| `src/images/worst_*` | 錯誤率最高的前 10 種犬種的視覺化結果 |
| `src/images/performance_summary.txt` | 文字檔案，包含訓練摘要與效能分析 |
| `model/model_epoch_*.pth` | 訓練過程中每 5 個 epoch 儲存的模型檢查點 |
| `firstSubmission.png` | 提交結果圖片，顯示在 Kaggle 上的提交分數 |
| `labels.csv` | 訓練集標籤檔案，包含每張圖片的 ID 與對應的品種 |
| `sample_submission.csv` | Kaggle 提供的提交範例格式 |
| `submission.csv` | 模型預測產生的提交檔案，用於 Kaggle 評分 |
| `.gitignore` | Git 版本控制忽略設定，排除不必要的檔案 |

## 效能分析

訓練過程包含提早停止機制以防止過度擬合。若驗證準確度連續 10 個 epoch 未提升，訓練將會提早停止。訓練完成後，詳細的效能摘要會儲存至 `src/images/performance_summary.txt`。


### 訓練過程

訓練過程中的損失曲線：

![訓練損失](src/images/loss_curve.png)

訓練過程中的準確度曲線：
![訓練準確度](src/images/accuracy_curve.png)

### 效能分析

訓練完成後，我們分析了模型在驗證集上的表現：

#### 表現最佳的犬種
模型在這些犬種上達到最高的準確度：

![表現最佳的犬種](src/images/best_breeds_summary.png)

各種表現最佳犬種的範例圖片，顯示正確的分類結果：
（請參閱 `src/images/best...` 目錄中的個別犬種圖片）

for example:
![表現最佳的犬種](src/images/best_1_african_hunting_dog.png)

#### 表現最差的犬種
模型在這些犬種上表現最差：

![表現最差的犬種](src/images/worst_breeds_summary.png)

for example:
![表現最差的犬種](src/images/worst_1_eskimo_dog.png)

各種表現最差犬種的範例圖片，顯示錯誤的分類結果：
（請參閱 `src/images/worst...` 目錄中的個別犬種圖片）

### 提交結果

提交至 Kaggle 的預測結果：

![提交結果](src/readme/firstSubmission.png) 

Cross Entropy Loss = 0.63572 (越小越好)

### 分析

#### 表現最差的犬種confusion matrix

![表現最差的犬種confusion matrix](src/images/worst_breed_confusion_matrix.png)

#### 表現最差的犬種heatmap

![表現最差的犬種heatmap](src/images/eskimo_dog_attention_heatmaps.png)

## 熱力圖分析與模型改進建議

### Eskimo Dog 分類錯誤原因分析

根據上述 Eskimo Dog 的注意力熱力圖分析，我們可以觀察到以下幾個關鍵問題：

#### 1. 模型注意力分散問題
- **背景干擾**：熱力圖顯示模型經常關注圖像的背景區域（如草地、雪地、建築物等），而非狗狗本身的特徵
- **非關鍵特徵**：模型可能過度關注狗狗的配件或環境因素，而忽略了品種特有的身體特徵
- **注意力不集中**：相比於表現良好的品種，Eskimo Dog 的熱力圖顯示注意力較為分散，缺乏對關鍵辨識特徵的聚焦

#### 2. 品種特徵相似性
- **毛色混淆**：Eskimo Dog 通常具有白色或淺色毛髮，容易與其他北極犬種（如 Samoyed、Siberian Husky 等）產生混淆
- **體型相似**：中型犬的體型特徵在圖像中較難區分，特別是在不同拍攝角度和距離下
- **面部特徵**：尖耳、楔形臉等特徵在多個犬種中都存在，增加了分類難度

#### 3. 訓練資料品質問題
- **樣本多樣性不足**：可能 Eskimo Dog 的訓練樣本在姿勢、角度、環境等方面缺乏足夠的多樣性
- **標註品質**：部分樣本可能存在標註錯誤或品種混淆的情況

### 模型改進建議
#### 1. 注意力機制優化
ResNet 50 是一種深度殘差網路，主要透過殘差塊來解決深層網路中的梯度消失問題，從而提高模型的訓練效果。相比之下，注意力機制則是通過動態調整網路對不同特徵的關注程度，來提升模型對關鍵特徵的識別能力。注意力機制可以在ResNet的基礎上進一步增強模型的表現，特別是在需要精確識別細微特徵的情境下，在學理分類上，Eskimo Dog 和 Husky 在品種特徵上有一些難以分辨的細微差異。Eskimo Dog，屬於尖嘴犬種，耳朵呈現尖形，這是其顯著特徵之一。然而，這些特徵在某些角度或光線下可能不易辨識。另一方面，Husky，耳朵較為圓潤，但在某些情況下，這些特徵可能會與其他犬種混淆。注意力機制可以幫助模型更好地識別這些細微但關鍵的品種差異，尤其是在這些難以分辨的情境中。

#### 2. 資料增強策略改進
- **焦點裁剪**：實施智能裁剪，確保狗狗主體佔據圖像的主要部分
- **背景替換**：使用背景替換技術減少環境因素的干擾
- **多尺度訓練**：加入不同尺度的圖像訓練，提高模型對不同大小狗狗的辨識能力

#### 3. 損失函數優化
建議使用 Focal Loss 來處理困難樣本。Focal Loss 是一種改進的損失函數，專門用於解決類別不平衡問題，特別是在目標檢測任務中。其主要特點是通過引入一個調整因子，降低對易分類樣本的損失貢獻，從而使模型更專注於困難樣本的學習。這對於像 Eskimo Dog 這樣容易與其他犬種混淆的品種，能夠有效提高分類準確率。Focal Loss 的公式中包含兩個重要參數：alpha 和 gamma。alpha 用於平衡正負樣本的影響，而 gamma 則控制難易樣本的權重調整。這樣的設計使得模型在訓練過程中能夠更好地聚焦於那些難以分類的樣本，從而提升整體的分類性能。

$$
FL(p_t) = -\alpha_t (1 - p_t)^\gamma \log(p_t)
$$

其中：
- $p_t$ 是模型對正確類別的預測概率。
- $\alpha_t$ 是平衡因子，用於調整正負樣本的影響。
- $\gamma$ 是調整因子，用於控制難易樣本的權重調整。

Focal Loss 通過引入 $(1 - p_t)^\gamma$ 項，降低對易分類樣本的損失貢獻，從而使模型更專注於困難樣本的學習。


#### 4. 模型架構改進
- **多尺度特徵融合**：結合不同層級的特徵圖，捕捉從細節到整體的多層次資訊
- **殘差注意力網路**：在 ResNet 基礎上加入注意力機制，提高對關鍵特徵的敏感度
- **集成學習**：訓練多個不同架構的模型，通過投票或加權平均提高預測準確性

#### 5. 訓練策略調整
- **困難樣本挖掘**：識別並重點訓練容易混淆的樣本對
- **漸進式解凍**：採用漸進式微調策略，逐步解凍更多的預訓練層
- **類別平衡**：針對表現較差的品種增加訓練樣本或調整類別權重

#### 6. 後處理優化
- **置信度閾值**：設定置信度閾值，對低置信度預測進行二次檢查
- **相似品種群組**：將相似的犬種分組，先進行粗分類再進行細分類